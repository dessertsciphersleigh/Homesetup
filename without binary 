#!/usr/bin/env bash
# -------------------------------------------------------------
# Tilix Session Logger
# -------------------------------------------------------------
# Records each interactive Bash session with:
#   - ANSI color output
#   - Timestamp for every executed command
#   - Plain-text logs (not binary)
#
# Compatible with:
#   - Tilix, GNOME Terminal, tmux
#   - Log rotation via logrotate
#
# Output logs: ~/.local/share/tilix_logs/YYYY-MM-DD_HH-MM-SS.log
# -------------------------------------------------------------

# --- Define log directory and file ---
LOGDIR="$HOME/.local/share/tilix_logs"
mkdir -p "$LOGDIR"
LOGFILE="$LOGDIR/$(date +%F_%H-%M-%S).log"

# Ensure file exists before script starts
touch "$LOGFILE"

# --- Create temporary RC file to inject preexec behavior ---
RCFILE=$(mktemp)

cat > "$RCFILE" <<'EOF'
# --- Custom Bash RC for session logging ---

# Reference the log file path
export LOGFILE

# Define preexec: executed before each command
preexec() {
  local ts
  ts="$(date '+%F %T')"
  echo -e "\n[\$ts] \$BASH_COMMAND" >> "\$LOGFILE"
}

# Ensure preexec is defined only once (no conflicts)
if declare -F preexec &>/dev/null; then
  :
else
  declare -fx preexec
fi
EOF

# --- Start interactive Bash session under 'script' ---
# --log-out: captures only visible output (no binary data)
# TERM=xterm-256color ensures color codes are preserved
TERM=xterm-256color script --quiet --log-out "$LOGFILE" bash --rcfile "$RCFILE"

# --- Cleanup ---
rm -f "$RCFILE"