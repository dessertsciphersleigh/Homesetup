#!/usr/bin/env bash
# ==========================================================
# Tilix session logger (fixed)
# - creates ~/tilix-logs if missing
# - generates a timestamped log file per session
# - records the entire terminal session with 'script'
# - sanitizes the tty string so no slashes end up in filenames
# ==========================================================

LOGDIR="$HOME/tilix-logs"
mkdir -p "$LOGDIR"

HOST=$(hostname -s)
USER_NOW=$(whoami)
TIMESTAMP=$(date +%Y%m%d-%H%M%S)

# Get the tty and sanitize it so it cannot contain slashes.
# Examples of results: "pts-6" or "tty1"
TTY_RAW=$(tty 2>/dev/null || echo "no-tty")
# remove leading path and replace any '/' with '-'
TTYNAME=$(echo "$TTY_RAW" | sed 's#.*/##; s#/#-#g; s/ /_/g')

LOGFILE="$LOGDIR/${HOST}_${USER_NOW}_${TIMESTAMP}_${TTYNAME}.log"

# Ensure the log file exists before running 'script'
touch "$LOGFILE"

# Avoid recursion if the script re-enters itself
if [ -z "$TILIX_LOGGER_ACTIVE" ]; then
  export TILIX_LOGGER_ACTIVE=1
  exec script -q -f -c "$SHELL --login" "$LOGFILE"
else
  exec "$SHELL" --login
fi