#!/usr/bin/env bash

INPUT_FILE="lista.txt"
OUTPUT_FILE="resultado.json"

# Función para escapar caracteres especiales en JSON
escape_json() {
    local str="$1"
    str="${str//\\/\\\\}"   # \
    str="${str//\"/\\\"}"   # "
    str="${str//
/\\n}"    # nueva línea
    str="${str//$'\t'/\\t}" # tab
    echo "$str"
}

echo "[" > "$OUTPUT_FILE"
first=1

while IFS=' ' read -r url string17; do
    # Ignorar líneas vacías
    [[ -z "$url" ]] && continue

    # Ejecutar curl
    response=$(curl -s -w "\n%{http_code}" "$url" -H "X-Custom: $string17")
    rc=$?

    # Separar cuerpo y status HTTP (última línea)
    body=$(echo "$response" | sed '$d')
    http_code=$(echo "$response" | tail -n1)

    # Escapar para JSON
    escaped_body=$(escape_json "$body")

    # Comas JSON
    if [[ $first -eq 0 ]]; then
        echo "," >> "$OUTPUT_FILE"
    fi
    first=0

    # Escribir bloque JSON
    cat >> "$OUTPUT_FILE" <<EOF
{
  "url": "$url",
  "string17": "$string17",
  "rc": $rc,
  "http_code": $http_code,
  "response": "$escaped_body"
}
EOF

done < "$INPUT_FILE"

echo "]" >> "$OUTPUT_FILE"