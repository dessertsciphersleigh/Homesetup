Param(
    [Parameter(Position=0, Mandatory=$true)]
    [ValidateSet("genkey","encrypt","decrypt")]
    [string]$Command,

    [string]$Public = "public.key",
    [string]$Private = "private.key.enc",
    [int]$KeySize = 4096,
    [string]$File
)

function Read-SecurePasswordBytes {
    $ss = Read-Host "Enter password" -AsSecureString
    $bstr = [Runtime.InteropServices.Marshal]::SecureStringToBSTR($ss)
    try {
        $plain = [Runtime.InteropServices.Marshal]::PtrToStringBSTR($bstr)
        return [System.Text.Encoding]::UTF8.GetBytes($plain)
    } finally {
        [Runtime.InteropServices.Marshal]::ZeroFreeBSTR($bstr) | Out-Null
    }
}

function Write-AllBytes { param($Path, $Data) [IO.File]::WriteAllBytes($Path,$Data) }
function Read-AllBytes  { param($Path)      [IO.File]::ReadAllBytes($Path) }

function Export-PublicKey {
    param($rsa)
    $xml = $rsa.ToXmlString($false)
    $wrap = "<XMLRSA>$xml</XMLRSA>"
    return [Text.Encoding]::UTF8.GetBytes($wrap)
}

function Export-PrivateKeyBytes {
    param($rsa)
    $xml = $rsa.ToXmlString($true)
    $wrap = "<XMLRSA>$xml</XMLRSA>"
    return [Text.Encoding]::UTF8.GetBytes($wrap)
}

function Import-PublicKey {
    param([byte[]]$bytes)
    $txt = [Text.Encoding]::UTF8.GetString($bytes)
    if ($txt.StartsWith("<XMLRSA>") -and $txt.EndsWith("</XMLRSA>")) {
        $xml = $txt.Substring(8, $txt.Length - 17)
        $rsa = [Security.Cryptography.RSA]::Create()
        $rsa.FromXmlString($xml)
        return $rsa
    }
    throw "Invalid public key format."
}

function Import-PrivateKeyFromBytes {
    param([byte[]]$bytes)
    $txt = [Text.Encoding]::UTF8.GetString($bytes)
    if ($txt.StartsWith("<XMLRSA>") -and $txt.EndsWith("</XMLRSA>")) {
        $xml = $txt.Substring(8, $txt.Length - 17)
        $rsa = [Security.Cryptography.RSA]::Create()
        $rsa.FromXmlString($xml)
        return $rsa
    }
    throw "Invalid private key format."
}

switch ($Command) {

"genkey" {
    Write-Host "Generating RSA keypair ($KeySize bits)..."

    $rsa = [Security.Cryptography.RSA]::Create($KeySize)

    $publicBytes = Export-PublicKey $rsa
    $privateBytes = Export-PrivateKeyBytes $rsa

    $passwordBytes = Read-SecurePasswordBytes

    $salt = New-Object byte[] 16
    [Security.Cryptography.RandomNumberGenerator]::Fill($salt)

    $pbkdf2 = New-Object Security.Cryptography.Rfc2898DeriveBytes($passwordBytes, $salt, 200000)
    $aesKey = $pbkdf2.GetBytes(32)

    $aes = [Security.Cryptography.Aes]::Create()
    $aes.KeySize = 256
    $aes.Key = $aesKey
    $aes.GenerateIV()

    $encPriv = $aes.CreateEncryptor().TransformFinalBlock($privateBytes,0,$privateBytes.Length)
    $pkg = $salt + $aes.IV + $encPriv

    Write-AllBytes $Private $pkg
    Write-AllBytes $Public $publicBytes

    Write-Host "Public key:  $Public"
    Write-Host "Private key: $Private (encrypted)"
    break
}

"encrypt" {
    if (-not $File) { throw "Missing -File" }
    if (-not (Test-Path $Public)) { throw "Public key not found" }

    $pub = Import-PublicKey (Read-AllBytes $Public)

    $aes = [Security.Cryptography.Aes]::Create()
    $aes.KeySize = 256
    $aes.GenerateKey()
    $aes.GenerateIV()

    $plain = Read-AllBytes $File
    $cipher = $aes.CreateEncryptor().TransformFinalBlock($plain,0,$plain.Length)

    $encAesKey = $pub.Encrypt($aes.Key, [Security.Cryptography.RSAEncryptionPadding]::OaepSHA256)

    $lenBytes = [BitConverter]::GetBytes([int]$encAesKey.Length)
    $out = $lenBytes + $encAesKey + $aes.IV + $cipher

    Write-AllBytes "$File.enc" $out
    Write-Host "Encrypted -> $File.enc"
    break
}

"decrypt" {
    if (-not $File) { throw "Missing -File" }
    if (-not (Test-Path $Private)) { throw "Private key not found" }

    $pkg = Read-AllBytes $Private
    $salt = $pkg[0..15]
    $ivPriv = $pkg[16..31]
    $encPriv = $pkg[32..($pkg.Length-1)]

    $passwordBytes = Read-SecurePasswordBytes

    $pbkdf2 = New-Object Security.Cryptography.Rfc2898DeriveBytes($passwordBytes, $salt, 200000)
    $aesKey = $pbkdf2.GetBytes(32)

    $aes = [Security.Cryptography.Aes]::Create()
    $aes.KeySize = 256
    $aes.Key = $aesKey
    $aes.IV = $ivPriv

    $privateBytes = $aes.CreateDecryptor().TransformFinalBlock($encPriv,0,$encPriv.Length)
    $rsa = Import-PrivateKeyFromBytes $privateBytes

    $edata = Read-AllBytes $File

    $len = [BitConverter]::ToInt32($edata,0)
    $offset = 4
    $encAesKey = $edata[$offset..($offset+$len-1)]
    $offset += $len
    $fileIV = $edata[$offset..($offset+15)]
    $offset += 16
    $cipher = $edata[$offset..($edata.Length-1)]

    $fileKey = $rsa.Decrypt($encAesKey, [Security.Cryptography.RSAEncryptionPadding]::OaepSHA256)

    $aes2 = [Security.Cryptography.Aes]::Create()
    $aes2.Key = $fileKey
    $aes2.IV = $fileIV

    $plain = $aes2.CreateDecryptor().TransformFinalBlock($cipher,0,$cipher.Length)

    $out = $File -replace "\.enc$",""
    if ($out -eq $File) { $out = "$File.dec" }

    Write-AllBytes $out $plain
    Write-Host "Decrypted -> $out"
    break
}

}